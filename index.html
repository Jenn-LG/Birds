<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <title>Clasificador de Aves</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #resultado {
            font-weight: bold;
            font-size: 3rem;
            text-align: center;
        }
        #modelo {
            font-size: 1.2rem;
            text-align: center;
            margin-top: 10px;
            color: #0dcaf0 !important;
        }

        body {
            background-color: #121212;
            color: #ffffff;
        }
        .border-bottom {
            border-bottom-color: #333 !important;
        }
        .btn-dark-mode {
            background-color: #f8f9fa;
            color: #212529;
        }

        body.light-mode {
            background-color: #ffffff;
            color: #212529;
        }
        .light-mode .border-bottom {
            border-bottom-color: #dee2e6 !important;
        }
        .light-mode #modelo {
            color: blue !important;
        }
        .light-mode .btn-dark-mode {
            background-color: #212529;
            color: #f8f9fa;
        }

        .footer {
            margin-top: 3rem;
            padding: 1.5rem 0;
            text-align: center;
            border-top: 1px solid #333;
        }
        .light-mode .footer {
            border-top-color: #dee2e6;
        }
        .github-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: inherit;
            text-decoration: none;
        }
        .github-link:hover {
            text-decoration: underline;
        }

        .logo-container {
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .logo-fallback {
            display: none;
            width: 100px;
            height: 100px;
            background-color: #f8f9fa;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #212529;
        }
        .light-mode .logo-fallback {
            background-color: #212529;
            color: #f8f9fa;
        }
    </style>
</head>
<body class="dark-mode">
<main>
    <div class="px-4 py-2 my-2 text-center border-bottom">
        <div class="text-end">
            <button id="darkModeToggle" class="btn btn-sm btn-dark-mode" onclick="toggleDarkMode()">
                <span id="darkModeIcon">‚òÄÔ∏è</span> Modo Claro
            </button>
        </div>

        <div class="logo-container">
            <img class="d-block mx-auto mb-2"
                 src="logo_mcd.png"
                 alt="Logo Clasificador Aves"
                 width="100"
                 height="100"
                 onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='flex';">
            <div id="logo-fallback" class="logo-fallback mx-auto mb-2">AVES</div>
        </div>

        <h1 class="display-5 fw-bold">Clasificador de Aves</h1>
        <div class="col-lg-6 mx-auto">
            <p class="lead mb-0">Clasificaci√≥n de im√°genes usando MobileNet y TensorFlow.js</p>
        </div>
    </div>

    <div class="container mt-5">
        <div class="row">
            <div class="col-12 col-md-4 offset-md-4 text-center">
                <video id="video" playsinline autoplay style="width: 1px;"></video>
                <button class="btn btn-info mb-2" onclick="switchCamera()">Cambiar C√°mara</button>
                <canvas id="canvas" width="400" height="400" style="max-width: 100%;"></canvas>
                <canvas id="otrocanvas" width="100" height="100" style="display: none;"></canvas>
                <div id="resultado">Cargando modelo...</div>
                <div id="modelo">Modelo no cargado</div>
            </div>
        </div>
    </div>
</main>

<footer class="footer">
    <div class="container">
        <a href="https://github.com/Jenn-LG/Birds" class="github-link" target="_blank" rel="noopener noreferrer">
            <svg height="20" viewBox="0 0 16 16" width="20" fill="currentColor">
                <path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2..."></path>
            </svg>
            Ver c√≥digo en GitHub
        </a>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
<script>
    let modelo = null;
    const tamano = 400;
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const otrocanvas = document.getElementById("otrocanvas");
    const ctx = canvas.getContext("2d");
    let currentStream = null;
    let currentFacingMode = "user";

    async function cargarModelo() {
        modelo = await tf.loadLayersModel("carpeta_salida/model.json");
        document.getElementById("modelo").innerText = "Modelo cargado: MobileNet";
        document.getElementById("resultado").innerText = "Modelo listo";
    }

    function mostrarCamara() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }
        navigator.mediaDevices.getUserMedia({
            video: { width: tamano, height: tamano, facingMode: currentFacingMode },
            audio: false
        }).then(stream => {
            currentStream = stream;
            video.srcObject = stream;
            procesarCamara();
            predecir();
        }).catch(err => {
            console.error("Error con la c√°mara:", err);
        });
    }

    function procesarCamara() {
        ctx.drawImage(video, 0, 0, tamano, tamano);
        setTimeout(procesarCamara, 20);
    }

    function predecir() {
        if (modelo) {
            const ctx2 = otrocanvas.getContext("2d");
            ctx2.drawImage(video, 0, 0, 100, 100);
            const imgData = ctx2.getImageData(0, 0, 100, 100);
            const arr = [];
            let fila = [];

            for (let i = 0; i < imgData.data.length; i += 4) {
                const r = imgData.data[i] / 255;
                const g = imgData.data[i + 1] / 255;
                const b = imgData.data[i + 2] / 255;
                fila.push([r, g, b]);
                if (fila.length === 100) {
                    arr.push(fila);
                    fila = [];
                }
            }

            const tensor = tf.tensor4d([arr]);
            const resultado = modelo.predict(tensor).dataSync();
            const pred = resultado.indexOf(Math.max(...resultado));
            document.getElementById("resultado").innerText = "Predicci√≥n: Ave " + pred;
        }
        setTimeout(predecir, 300);
    }

    function toggleDarkMode() {
        const body = document.body;
        const icon = document.getElementById("darkModeIcon");
        const toggle = document.getElementById("darkModeToggle");
        if (body.classList.contains("dark-mode")) {
            body.classList.replace("dark-mode", "light-mode");
            icon.textContent = "üåô";
            toggle.textContent = "üåô Modo Oscuro";
        } else {
            body.classList.replace("light-mode", "dark-mode");
            icon.textContent = "‚òÄÔ∏è";
            toggle.textContent = "‚òÄÔ∏è Modo Claro";
        }
    }

    function switchCamera() {
        currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
        mostrarCamara();
    }

    window.onload = function () {
        mostrarCamara();
        cargarModelo();
        setTimeout(() => {
            const logo = document.querySelector('.logo-container img');
            if (!logo.complete || logo.naturalWidth === 0) {
                logo.style.display = 'none';
                document.getElementById('logo-fallback').style.display = 'flex';
            }
        }, 1000);
    };
</script>
</body>
</html>
