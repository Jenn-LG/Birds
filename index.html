<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Clasificador de Aves</title>
    <link rel="icon" href="favicon-32x32.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #121212;
            color: #fff;
        }
        .light-mode {
            background-color: #fff;
            color: #212529;
        }
        .btn-dark-mode {
            background-color: #f8f9fa;
            color: #212529;
        }
        .light-mode .btn-dark-mode {
            background-color: #212529;
            color: #f8f9fa;
        }
        #resultado {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="dark-mode">
    <main class="container text-center py-4">
        <div class="text-end mb-3">
            <button id="darkModeToggle" class="btn btn-sm btn-dark-mode" onclick="toggleDarkMode()">
                <span id="darkModeIcon">‚òÄÔ∏è</span> Modo Claro
            </button>
        </div>
        <h1>Clasificador de Aves</h1>
        <p>Clasifica aves usando MobileNet y TensorFlow.js</p>
        <video id="video" autoplay playsinline style="width: 1px;"></video>
        <button class="btn btn-info my-2" onclick="switchCamera()">Cambiar C√°mara</button>
        <canvas id="canvas" width="400" height="400" style="max-width: 100%;"></canvas>
        <canvas id="otrocanvas" width="100" height="100" style="display: none;"></canvas>
        <div id="resultado">Cargando modelo...</div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
    <script>
        let modelo = null;
        let tamano = 400;
        let video = document.getElementById("video");
        let canvas = document.getElementById("canvas");
        let otrocanvas = document.getElementById("otrocanvas");
        let ctx = canvas.getContext("2d");
        let currentStream = null;
        let currentFacingMode = "user";

        async function cargarModelo() {
            modelo = await tf.loadLayersModel("carpeta_salida/model.json");
            document.getElementById("resultado").innerText = "Modelo cargado. Analizando...";
        }

        function mostrarCamara() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            navigator.mediaDevices.getUserMedia({
                video: { width: tamano, height: tamano, facingMode: currentFacingMode },
                audio: false
            }).then(stream => {
                currentStream = stream;
                video.srcObject = stream;
                procesarCamara();
                predecir();
            }).catch(err => {
                console.error("Error con la c√°mara:", err);
            });
        }

        function procesarCamara() {
            ctx.drawImage(video, 0, 0, tamano, tamano);
            setTimeout(procesarCamara, 20);
        }

        function predecir() {
            if (modelo) {
                let ctx2 = otrocanvas.getContext("2d");
                ctx2.drawImage(video, 0, 0, 100, 100);
                let imgData = ctx2.getImageData(0, 0, 100, 100);
                let arr = [], fila = [];

                for (let i = 0; i < imgData.data.length; i += 4) {
                    let r = imgData.data[i] / 255;
                    let g = imgData.data[i + 1] / 255;
                    let b = imgData.data[i + 2] / 255;
                    fila.push([r, g, b]);
                    if (fila.length === 100) {
                        arr.push(fila);
                        fila = [];
                    }
                }

                const input = tf.tensor4d([arr]);
                const pred = modelo.predict(input).dataSync();
                const clase = pred.indexOf(Math.max(...pred));
                document.getElementById("resultado").innerText = `Predicci√≥n: Ave ${clase}`;
            }
            setTimeout(predecir, 300);
        }

        function toggleDarkMode() {
            const body = document.body;
            const toggle = document.getElementById("darkModeToggle");
            const icon = document.getElementById("darkModeIcon");

            if (body.classList.contains("dark-mode")) {
                body.classList.replace("dark-mode", "light-mode");
                icon.textContent = "üåô";
                toggle.textContent = "üåô Modo Oscuro";
                localStorage.setItem("darkMode", "off");
            } else {
                body.classList.replace("light-mode", "dark-mode");
                icon.textContent = "‚òÄÔ∏è";
                toggle.textContent = "‚òÄÔ∏è Modo Claro";
                localStorage.setItem("darkMode", "on");
            }
        }

        function switchCamera() {
            currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
            mostrarCamara();
        }

        window.onload = function() {
            mostrarCamara();
            cargarModelo();
        };
    </script>
</body>
</html>
